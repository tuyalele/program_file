C51 COMPILER V9.54   UART                                                                  02/27/2021 10:59:47 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN .\Objects\UART.obj
COMPILER INVOKED BY: H:\Keil_v5\C51\BIN\C51.EXE UART\UART.c COMPACT RTX51 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\H;.\mcu_sdk;
                    -.\UART;.\0.96OLED;.\SHT30) DEBUG OBJECTEXTEND PRINT(.\Listings\UART.lst) TABS(2) OBJECT(.\Objects\UART.obj)

line level    source

   1          
   2          /*---------------------------------------------------------------------*/
   3          /* --- STC MCU International Limited ----------------------------------*/
   4          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
   5          /* --- Mobile: (86)13922805190 ----------------------------------------*/
   6          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
   7          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
   8          /* --- Web: www.GXWMCU.com --------------------------------------------*/
   9          /* --- QQ:  800003751 -------------------------------------------------*/
  10          /* Èç¹ûÒªÔÚ³ÌĞòÖĞÊ¹ÓÃ´Ë´úÂë,ÇëÔÚ³ÌĞòÖĞ×¢Ã÷Ê¹ÓÃÁËºê¾§¿Æ¼¼µÄ×ÊÁÏ¼°³ÌĞò   */
  11          /*---------------------------------------------------------------------*/
  12          
  13          
  14          //#define MAIN_Fosc   22118400L //¶¨ÒåÖ÷Ê±ÖÓ
  15          
  16          #include  "STC15Fxxxx.H"
  17          #include  "UART1-2.H"
  18          
  19          #define   Baudrate1 115200UL
  20          #define   Baudrate2 115200UL
  21          
  22          
  23          
  24          /*************  ¹¦ÄÜËµÃ÷  **************m
  25          
  26          Ë«´®¿ÚÈ«Ë«¹¤ÖĞ¶Ï·½Ê½ÊÕ·¢Í¨Ñ¶³ÌĞò¡£
  27          
  28          ******************************************/
  29          
  30          
  31          
  32          
  33          u8  TX1_Cnt;  //·¢ËÍ¼ÆÊı
  34          u8  RX1_Cnt;  //½ÓÊÕ¼ÆÊı
  35          u8  TX2_Cnt;  //·¢ËÍ¼ÆÊı
  36          u8  RX2_Cnt;  //½ÓÊÕ¼ÆÊı
  37          bit B_TX1_Busy; //·¢ËÍÃ¦±êÖ¾
  38          bit B_TX2_Busy; //·¢ËÍÃ¦±êÖ¾
  39          u8  idata RX1_Buffer[UART1_BUF_LENGTH]; //½ÓÊÕ»º³å
  40          u8  idata RX2_Buffer[UART2_BUF_LENGTH]; //½ÓÊÕ»º³å
  41          
  42          
  43          
  44          
  45          
  46          //========================================================================
  47          // º¯Êı: void PrintString1(u8 *puts)
  48          // ÃèÊö: ´®¿Ú1·¢ËÍ×Ö·û´®º¯Êı¡£
  49          // ²ÎÊı: puts:  ×Ö·û´®Ö¸Õë.
  50          // ±¸×¢: 
  51          //========================================================================
  52          void PrintString1(u8 *puts)
  53          {
  54   1          for (; *puts != 0;  puts++)     //Óöµ½Í£Ö¹·û0½áÊø
C51 COMPILER V9.54   UART                                                                  02/27/2021 10:59:47 PAGE 2   

  55   1        {
  56   2          SBUF = *puts;
  57   2          B_TX1_Busy = 1;
  58   2          while(B_TX1_Busy);
  59   2        }
  60   1      }
  61          
  62          
  63          //========================================================================
  64          // º¯Êı: void PrintD1(const char *str)
  65          // ÃèÊö: ´®¿Ú1·¢ËÍ×Ö·û´®º¯Êı¡£
  66          // ²ÎÊı: puts:  ×Ö·û´®Ö¸Õë.
  67          // ±¸×¢: 
  68          //========================================================================
  69          void PrintD1(const char *str)
  70          {
  71   1      char *s;
  72   1           
  73   1          for (s = (char *)str; *s; s++)
  74   1          {
  75   2              Printchar1(*s);
  76   2          }
  77   1         
  78   1      }
  79          //========================================================================
  80          // º¯Êı: void PrintN1(int num)
  81          // ÃèÊö: ´®¿Ú1·¢ËÍÊıÖµº¯Êı¡£
  82          // ²ÎÊı: num:  ÊıÖµ.
  83          // ±¸×¢: ·¶Î§-+99999
  84          //========================================================================
  85          void PrintN1(int num)
  86          {
  87   1        
  88   1      if(num >= 0){
  89   2        if(num < 100000)
  90   2          {
  91   3            if(num < 10)
  92   3              {
  93   4                Printchar1(num + 0x30);
  94   4              }
  95   3            if(num>=10 && num < 100)
  96   3              {
  97   4                Printchar1((num / 100) + 0x30);
  98   4                Printchar1((num % 100)/10 + 0x30);
  99   4              }
 100   3            if(num >= 100 && num < 1000)
 101   3              {
 102   4                Printchar1((num / 100) + 0x30);
 103   4                Printchar1((num % 100)/10 + 0x30);
 104   4                Printchar1((num % 100)%10 + 0x30);
 105   4              }
 106   3            if(num >= 1000 && num < 10000)
 107   3              {
 108   4                Printchar1((num / 1000) + 0x30);
 109   4                Printchar1((num % 1000)/100 + 0x30);
 110   4                Printchar1((num % 1000)%100/10 + 0x30);
 111   4                Printchar1((num % 1000)%100%10 + 0x30);
 112   4              } 
 113   3            if(num >= 10000 && num < 100000)
 114   3              {
 115   4              Printchar1((num / 10000) + 0x30);
 116   4                Printchar1((num % 10000)/1000 + 0x30);
C51 COMPILER V9.54   UART                                                                  02/27/2021 10:59:47 PAGE 3   

 117   4                Printchar1((num % 10000)%1000/100 + 0x30);
 118   4                Printchar1((num % 10000)%1000%100/10 + 0x30);
 119   4                Printchar1((num % 10000)%1000%100%10 + 0x30);
 120   4            
 121   4              }
 122   3      
 123   3          }
 124   2        
 125   2      }
 126   1      
 127   1      if(num < 0){
 128   2        num = -num;
 129   2        
 130   2        Printchar1('-');
 131   2        
 132   2        if(num < 100000)
 133   2          {
 134   3            if(num < 10)
 135   3              {
 136   4                Printchar1(num + 0x30);
 137   4              }
 138   3            if(num>=10 && num < 100)
 139   3              {
 140   4                Printchar1((num / 100) + 0x30);
 141   4                Printchar1((num % 100)/10 + 0x30);
 142   4              }
 143   3            if(num >= 100 && num < 1000)
 144   3              {
 145   4                Printchar1((num / 100) + 0x30);
 146   4                Printchar1((num % 100)/10 + 0x30);
 147   4                Printchar1((num % 100)%10 + 0x30);
 148   4              }
 149   3            if(num >= 1000 && num < 10000)
 150   3              {
 151   4                Printchar1((num / 1000) + 0x30);
 152   4                Printchar1((num % 1000)/100 + 0x30);
 153   4                Printchar1((num % 1000)%100/10 + 0x30);
 154   4                Printchar1((num % 1000)%100%10 + 0x30);
 155   4              } 
 156   3            if(num >= 10000 && num < 100000)
 157   3              {
 158   4              Printchar1((num / 10000) + 0x30);
 159   4                Printchar1((num % 10000)/1000 + 0x30);
 160   4                Printchar1((num % 10000)%1000/100 + 0x30);
 161   4                Printchar1((num % 10000)%1000%100/10 + 0x30);
 162   4                Printchar1((num % 10000)%1000%100%10 + 0x30);
 163   4            
 164   4              }
 165   3      
 166   3          }
 167   2      }
 168   1      
 169   1      }
 170          
 171          
 172          //========================================================================
 173          // º¯Êı: void Printchae1(char Data)
 174          // ÃèÊö: ´®¿Ú1·¢ËÍ×Ö·ûº¯Êı¡£
 175          // ²ÎÊı: Data:  ×Ö·û.
 176          // ±¸×¢: 
 177          //========================================================================
 178          void Printchar1(char Data)
C51 COMPILER V9.54   UART                                                                  02/27/2021 10:59:47 PAGE 4   

 179          {
 180   1      
 181   1          SBUF = Data;
 182   1          B_TX1_Busy = 1;
 183   1          while(B_TX1_Busy);
 184   1      
 185   1      }
 186          
 187          
 188          
 189          //========================================================================
 190          // º¯Êı: void Printchar2(char Data)
 191          // ÃèÊö: ´®¿Ú2·¢ËÍ×Ö·ûº¯Êı¡£
 192          // ²ÎÊı: Data:  ×Ö·û.
 193          // ±¸×¢: 
 194          //========================================================================
 195          void Printchar2(char Data)
 196          {
 197   1      
 198   1          S2BUF = Data;
 199   1          B_TX2_Busy = 1;
 200   1          while(B_TX2_Busy);
 201   1        
 202   1      }
 203          //========================================================================
 204          // º¯Êı: void PrintString2(u8 *puts)
 205          // ÃèÊö: ´®¿Ú2·¢ËÍ×Ö·û´®º¯Êı¡£
 206          // ²ÎÊı: puts:  ×Ö·û´®Ö¸Õë.
 207          // ±¸×¢: 
 208          //========================================================================
 209          void PrintString2(u8 *puts)
 210          {
 211   1          for (; *puts != 0;  puts++)     //Óöµ½Í£Ö¹·û0½áÊø
 212   1        {
 213   2          S2BUF = *puts;
 214   2          B_TX2_Busy = 1;
 215   2          while(B_TX2_Busy);
 216   2        }
 217   1      }
 218          
 219          //========================================================================
 220          // º¯Êı: SetTimer2Baudraye(u16 dat)
 221          // ÃèÊö: ÉèÖÃTimer2×ö²¨ÌØÂÊ·¢ÉúÆ÷¡£
 222          // ²ÎÊı: dat: Timer2µÄÖØ×°Öµ.
 223          // ±¸×¢: 
 224          //========================================================================
 225          void  SetTimer2Baudraye(u16 dat)
 226          {
 227   1        AUXR &= ~(1<<4);  //Timer stop
 228   1        AUXR &= ~(1<<3);  //Timer2 set As Timer
 229   1        AUXR |=  (1<<2);  //Timer2 set as 1T mode
 230   1        T2H = dat / 256;
 231   1        T2L = dat % 256;
 232   1        IE2  &= ~(1<<2);  //½ûÖ¹ÖĞ¶Ï
 233   1        AUXR |=  (1<<4);  //Timer run enable
 234   1      }
 235          
 236          //========================================================================
 237          // º¯Êı: void UART1_config(u8 brt)
 238          // ÃèÊö: UART1³õÊ¼»¯º¯Êı¡£
 239          // ²ÎÊı: brt: Ñ¡Ôñ²¨ÌØÂÊ, 2: Ê¹ÓÃTimer2×ö²¨ÌØÂÊ, ÆäËüÖµ: Ê¹ÓÃTimer1×ö²¨ÌØÂÊ.
 240          // ±¸×¢: 
C51 COMPILER V9.54   UART                                                                  02/27/2021 10:59:47 PAGE 5   

 241          //========================================================================
 242          void  UART1_config(u8 brt)
 243          {
 244   1        /*********** ²¨ÌØÂÊÊ¹ÓÃ¶¨Ê±Æ÷2 *****************/
 245   1        if(brt == 2)
 246   1        {
 247   2          AUXR |= 0x01;   //S1 BRT Use Timer2;
 248   2          SetTimer2Baudraye(65536UL - (MAIN_Fosc / 4) / Baudrate1);
 249   2        }
 250   1      
 251   1        /*********** ²¨ÌØÂÊÊ¹ÓÃ¶¨Ê±Æ÷1 *****************/
 252   1        else
 253   1        {
 254   2          TR1 = 0;
 255   2          AUXR &= ~0x01;    //S1 BRT Use Timer1;
 256   2          AUXR |=  (1<<6);  //Timer1 set as 1T mode
 257   2          TMOD &= ~(1<<6);  //Timer1 set As Timer
 258   2          TMOD &= ~0x30;    //Timer1_16bitAutoReload;
 259   2          TH1 = (u8)((65536UL - (MAIN_Fosc / 4) / Baudrate1) / 256);
 260   2          TL1 = (u8)((65536UL - (MAIN_Fosc / 4) / Baudrate1) % 256);
 261   2          ET1 = 0;  //½ûÖ¹ÖĞ¶Ï
 262   2          INT_CLKO &= ~0x02;  //²»Êä³öÊ±ÖÓ
 263   2          TR1  = 1;
 264   2        }
 265   1        /*************************************************/
 266   1      
 267   1        SCON = (SCON & 0x3f) | 0x40;  //UART1Ä£Ê½, 0x00: Í¬²½ÒÆÎ»Êä³ö, 0x40: 8Î»Êı¾İ,¿É±ä²¨ÌØÂÊ, 0x80: 9Î»Êı¾İ,¹Ì¶
             -¨²¨ÌØÂÊ, 0xc0: 9Î»Êı¾İ,¿É±ä²¨ÌØÂÊ
 268   1      //  PS  = 1;  //¸ßÓÅÏÈ¼¶ÖĞ¶Ï
 269   1        ES  = 1;  //ÔÊĞíÖĞ¶Ï
 270   1      //  ES  = 0;  //²»ÔÊĞíÖĞ¶Ï
 271   1        REN = 1;  //ÔÊĞí½ÓÊÕ
 272   1        P_SW1 &= 0x3f;
 273   1        P_SW1 |= 0x00;    //UART1 switch to, 0x00: P3.0 P3.1, 0x40: P3.6 P3.7, 0x80: P1.6 P1.7 (±ØĞëÊ¹ÓÃÄÚ²¿Ê±ÖÓ)
 274   1      //  PCON2 |=  (1<<4); //ÄÚ²¿¶ÌÂ·RXDÓëTXD, ×öÖĞ¼Ì, ENABLE,DISABLE
 275   1      
 276   1        B_TX1_Busy = 0;
 277   1        TX1_Cnt = 0;
 278   1        RX1_Cnt = 0;
 279   1      }
 280          
 281          
 282          //========================================================================
 283          // º¯Êı: void UART2_config(u8 brt)
 284          // ÃèÊö: UART2³õÊ¼»¯º¯Êı¡£
 285          // ²ÎÊı: brt: Ñ¡Ôñ²¨ÌØÂÊ, 2: Ê¹ÓÃTimer2×ö²¨ÌØÂÊ, ÆäËüÖµ: ÎŞĞ§.
 286          // ±¸×¢: 
 287          //========================================================================
 288          void  UART2_config(u8 brt)  // Ñ¡Ôñ²¨ÌØÂÊ, 2: Ê¹ÓÃTimer2×ö²¨ÌØÂÊ, ÆäËüÖµ: ÎŞĞ§.
 289          {
 290   1        if(brt == 2)
 291   1        {
 292   2          SetTimer2Baudraye(65536UL - (MAIN_Fosc / 4) / Baudrate2);
 293   2      
 294   2          S2CON &= ~(1<<7); // 8Î»Êı¾İ, 1Î»ÆğÊ¼Î», 1Î»Í£Ö¹Î», ÎŞĞ£Ñé
 295   2          IE2   |= 1;     //ÔÊĞíÖĞ¶Ï
 296   2          S2CON |= (1<<4);  //ÔÊĞí½ÓÊÕ
 297   2          P_SW2 &= ~0x01; 
 298   2          P_SW2 |= 0;     //UART2 switch to: 0: P1.0 P1.1,  1: P4.6 P4.7
 299   2      
 300   2          B_TX2_Busy = 0;
 301   2          TX2_Cnt = 0;
C51 COMPILER V9.54   UART                                                                  02/27/2021 10:59:47 PAGE 6   

 302   2          RX2_Cnt = 0;
 303   2        }
 304   1      }
 305          
 306          
 307          
 308          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1279    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =      4       5
   DATA SIZE        =   ----    ----
   IDATA SIZE       =     64    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
